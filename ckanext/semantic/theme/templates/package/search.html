{% ckan_extends %}

{% block secondary_content %}

  {{ super() }}

  <section class="module module-narrow">
    <h2 class="module-heading"><i class="icon-medium icon-filter"></i> Topic</h2>
    <div class="module-content">
      <form method="get">
        <input id="topic_input" type="text" class="input" name="topic" style="height:14px; width:115px" value="http://purl.org/ontology/bibo/" placeholder="http://purl.org/ontology/bibo/" />
          {% snippet "snippets/params_to_hidden.html", name_value_pairs=c.search_url_params %}
        <button type="submit" class="btn" style="height:34px; margin-top:-10px">Add</button>
      </form>
    </div>
        
    {% for name_value_pair in c.search_url_params.split('&') %}
      {% set name_value = name_value_pair.split('=') %}
      {% set name = name_value[0] %}
      {% set value = h.unquote(name_value[1]) %}
      {% if name in ['topic'] %}
        <form method="get" style="margin:0">
          <button type="submit" style="background:white; border-left: 0; border-right: 0; border-top: 1px dotted; border-bottom: 0; height:27px; text-align:left; width:220px; padding-left:15px" >{{ value }}&nbsp; &nbsp; X</button>
          {% snippet "snippets/params_to_hidden.html", name_value_pairs=c.search_url_params, except_name='topic', except_value=value%}
        </form>
      {% endif %}
    {% endfor %}
  </section>

  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet-0.4/leaflet.js"></script>
  <section class="module module-narrow">
    <h2 class="module-heading"><i class="icon-medium icon-filter"></i> Location</h2>
    <div id="map" style="height:280px"></div>
    <div class="module-content">
      <form name="location" method="get">
        Latitude <input type="text" class="input" name="location_latitude" style="height:14px; width:165px" value="{{ c.fields_grouped.location_latitude[0] }}" placeholder="40.417" />
        Longitude <input type="text" class="input" name="location_longitude" style="height:14px; width:165px" value="{{ c.fields_grouped.location_longitude[0] }}" placeholder="-3.703" />
        Radius <input type="text" class="input" name="location_radius" style="height:14px; width:165px" value="{{ c.fields_grouped.location_radius[0] }}" placeholder="50" />

      {% if c.fields_grouped.location_latitude[0] %}
        {#{% snippet "snippets/params_to_hidden.html", name_value_pairs=c.search_url_params %}#}
        <button type="submit" class="btn" style="height:34px; margin-top:-10px">Update</button>
      {% else %}
        <button type="submit" class="btn" style="height:34px; margin-top:-10px">Apply</button>
      {% endif %}

      </form>
      {% if c.fields_grouped.location_latitude[0] %}
        <form method="get">
          <button type="submit" class="btn" style="height:34px; margin-top:-10px">Remove</button>
{#          {% snippet "snippets/params_to_hidden.html", name_value_pairs=c.search_url_params, except_name=['location_latitude', 'location_longitude', 'location_radius']%}#}
        </form>
      {% endif %}
    </div>
    
    <script>
        var latitude = document.forms.location.location_latitude
        var longitude =document.forms.location.location_longitude
        var radius = document.forms.location.location_radius
    
        var map = L.map('map')
        
        map.setView([0, 0], 0)
        
        L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
            maxZoom: 20
        }).addTo(map);

        var circle = null;
        
        function onMapClick(event)
        {
            latitude.value = event.latlng.lat;
            longitude.value = event.latlng.lng;
            
            update_circle(false);
        }
        map.on('click', onMapClick);
        
        function update_circle(moveMap)
        {
            var lat = parseFloat(latitude.value);
            var lng = parseFloat(longitude.value);
            var rad = parseFloat(radius.value);
        
            if(circle)
            {
                map.removeLayer(circle);
            }
            
            circle = L.circle([lat, lng], 1000.0 * rad, {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5
            }).addTo(map);

            circle.on('click', onMapClick);

            if (moveMap)
            {
                var bounds = circle.getBounds();
                var zoom = map.getBoundsZoom(bounds, inside=false);
                map.setView([lat, lng], Math.max(0, zoom-2));
            }
        }

        latitude.addEventListener('change', function(){update_circle(true);});
        longitude.addEventListener('change', function(){update_circle(true);});
        radius.addEventListener('change', function(){update_circle(true);});

        if(latitude.value)
        {
            update_circle(true);
        }
    </script> 
           
  </section>
  
  <section class="module module-narrow">
    <h2 class="module-heading"><i class="icon-medium icon-filter"></i> Time</h2>
    <div class="module-content">
    </div>
  </section>
  
{% endblock %}


{#
{% block scripts %}
  {{ super() }}
  
  <script src='scripts/subscription/semantic.js'></script>
{% endblock %}
#}
